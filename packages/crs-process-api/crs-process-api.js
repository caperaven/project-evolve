var u=class{constructor(){this._schemas={},crs.binding.events.emitter.on("run-process",this._runProcess.bind(this))}_runProcess(t){return new Promise(async(s,e)=>{let i=t.step.action,n=t.step.args.schema,d=this._schemas[n];if(d==null&&crs.process.fetch!=null&&(d=await crs.process.fetch(t.step),this.add(d)),d==null)throw new Error(`process "${n}" not in registry and not loaded.`);let c=d[i];c.name=i,await b(c,t.parameters);let l=await crs.process.run(t.context,c,t.item,null,t.prefixes).catch(o=>{let $=c.aborted==!0?"crs-process-aborted":"crs-process-error";crs.binding.events.emitter.emit($,{step:c.currentStep,error:o}),t.step.aborted=!0}),r=t.step.args?.target;r!=null&&await crs.process.setValue(r,l,t.context,t.process,t.item),s(l)})}add(t){this._schemas[t.id]=t}remove(t){delete this._schemas[t.id]}};async function b(a,t){if(t!=null){a.parameters=a.parameters||{};for(let[s,e]of Object.entries(t))a.parameters[s]=e}}var m=class{static run(t,s,e,i,n){return new Promise(async(d,c)=>{s=JSON.parse(JSON.stringify(s)),s.data=s.data||{},s.context=t,s.functions={},s.text=i,s.expCache={},f(n,s),s.bindable==!0&&(crs.intent.binding==null&&await crs.modules.get("binding"),await crs.intent.binding.create_context(null,t,s,null)),await crs.binding.events.emitter.emit("process-starting",s),await crs.binding.idleTaskManager.add(async()=>{let l;await g(t,s,e).catch(r=>{s.aborted=!0,c({process:s.name,step:s.currentStep,error:r})}),await this.runStep(s.steps.start,t,s,e).then(async()=>{l=s.result,await this.cleanProcess(s)}).then(()=>d(l)).catch(r=>{s.aborted=!0,c({process:s.name,step:s.currentStep,error:r})})})})}static async runStep(t,s=null,e=null,i=null,n=null){if(t==null)return;await y("binding_before",t,s,e,i);let d;if(t.type!=null&&(crs.intent[t.type]==null&&await crs.modules.get(t.type),d=await crs.intent[t.type].perform(t,s,e,i)),t.args?.log!=null){let c=await this.getValue(t.args.log,s,e,i);console.log(c)}if(await y("binding_after",t,s,e,i),e?.aborted!==!0&&t.aborted!==!0){n||=e.steps;let c=n?.[t.alt_next_step||t.next_step];if(e!=null&&(e.currentStep=t.next_step),c!=null)return await this.runStep(c,s,e,i,n)}return d}static async getValue(t,s=null,e=null,i=null){if(typeof t!="string"||t.indexOf("${")==0||t.indexOf("$template")!=-1)return t;if(t=="$context")return s;if(t=="$process")return e;if(t=="$item")return i;if(t.indexOf("$")==-1)return t;if(t.indexOf("$binding")!=-1)return await crs.binding.data.getProperty(e.parameters.bId,t.replace("$binding.",""));if(t.indexOf("$fn")!=-1&&(t=t.split("$fn").join("")),t=e?.expCache==null?t:w(t,e),t.indexOf("rgb(")!=-1)return t;let n=e?.functions?.[t];if(n==null){let d=t.split("$").join("");n=new Function("context","process","item",`return ${d};`),e!=null&&e.functions!=null&&(e.functions[t]=n)}return n(s,e,i)}static async setValue(t,s,e,i,n){let d;if(t=i?.expCache==null?t:w(t,i),t.indexOf("$binding")!=-1){let l=i.parameters?.bId,r=t.split(".")[1];return crs.binding.data.setProperty(l,r,s)}t.indexOf("$item")!=-1?(d=n,t=t.replace("$item.","")):t.indexOf("$process")!=-1?(d=i,t=t.replace("$process.","")):(d=e,t=t.replace("$context.",""));let c=d;if(t.indexOf(".")==-1)c[t]=await this.getValue(s,e,i,n);else{let l=t.split(".");for(let r=0;r<l.length-1;r++){let o=l[r];c=c[o]=c[o]||{}}s=await this.getValue(s,e,i,n),c[l[l.length-1]]=s}}static async cleanProcess(t){t.bindable==!0&&crs.binding.data.remove(t.parameters.bId),await this.cleanObject(t.data),await this.cleanObject(t.functions),delete t.context,delete t.functions,delete t.parameters,delete t.result,delete t.data,delete t.steps,delete t.text,delete t.prefixes,delete t.expCache,await crs.binding.events.emitter.emit("process-ended",t)}static async cleanObject(t){if(t==null)return;let s=Object.keys(t);for(let e of s)delete t[e];return null}};async function y(a,t,s,e,i){crs.intent.binding==null&&await crs.modules.get("binding");let n=t[a];if(n==null||e.parameters?.bId==null)return;let d=Object.keys(n);for(let c of d)await crs.intent.binding.set_property({args:{property:c,value:n[c]}},s,e,i)}async function g(a,t,s){if(t.parameters_def==null)return;t.parameters=t.parameters||{};let e=!0;for(let[i,n]of Object.entries(t.parameters_def))if(n.required===!0&&(t.parameters[i]==null&&n.default!=null&&(t.parameters[i]=await crs.process.getValue(n.default,a,t,s)),e=t.parameters[i]!=null),e===!1)throw t.aborted=!0,t.currentStep="validate process parameters",new Error(`required parameter "${i}" not set or is null`)}function f(a,t){t.prefixes=t.prefixes||{},a!=null&&Object.assign(t.prefixes,a),t.prefixes.$text="$process.text",t.prefixes.$data="$process.data",t.prefixes.$parameters="$process.parameters",t.prefixes.$bId="$process.parameters.bId",t.prefixes.$global="globalThis",t.prefixes.$translation='crs.binding.translations.get("$0")'}function w(a,t){if(t==null)return a;if(t.expCache[a]!=null)return t.expCache[a];let s=a,e=a.split("."),i=e[0];if(t?.prefixes[i]==null)return a;e.splice(0,1);let n=t.prefixes[i];if(n.indexOf("$0")!=-1){let d=e.join(".");a=n.replace("$0",d)}else a=a.split(i).join(n);return t.expCache[s]=a,a}async function v(a){await crs.modules.add("action",`${a}/action-systems/action-actions.js`),await crs.modules.add("array",`${a}/action-systems/array-actions.js`),await crs.modules.add("binding",`${a}/action-systems/binding-actions.js`),await crs.modules.add("colors",`${a}/action-systems/colors-actions.js`),await crs.modules.add("compile",`${a}/action-systems/compile-actions.js`),await crs.modules.add("component",`${a}/action-systems/component-actions.js`),await crs.modules.add("condition",`${a}/action-systems/condition-actions.js`),await crs.modules.add("console",`${a}/action-systems/console-actions.js`),await crs.modules.add("cssgrid",`${a}/action-systems/css-grid-actions.js`),await crs.modules.add("data",`${a}/action-systems/data-actions.js`),await crs.modules.add("data_processing",`${a}/action-systems/data-processing-actions.js`),await crs.modules.add("date",`${a}/action-systems/date-actions.js`),await crs.modules.add("debug",`${a}/action-systems/debug-actions.js`),await crs.modules.add("dom",`${a}/action-systems/dom-actions.js`),await crs.modules.add("dom_binding",`${a}/action-systems/dom-binding-actions.js`),await crs.modules.add("dom_collection",`${a}/action-systems/dom-collection-actions.js`),await crs.modules.add("dom_interactive",`${a}/action-systems/dom-interactive-actions.js`),await crs.modules.add("dom_observer",`${a}/action-systems/dom-observer-actions.js`),await crs.modules.add("dom_utils",`${a}/action-systems/dom-utils-actions.js`),await crs.modules.add("dom_widget",`${a}/action-systems/dom-widgets-actions.js`),await crs.modules.add("events",`${a}/action-systems/events-actions.js`),await crs.modules.add("files",`${a}/action-systems/files-actions.js`),await crs.modules.add("fs",`${a}/action-systems/fs-actions.js`),await crs.modules.add("fixed_layout",`${a}/action-systems/fixed-layout-actions.js`),await crs.modules.add("fixed_position",`${a}/action-systems/fixed-position-actions.js`),await crs.modules.add("fs",`${a}/action-systems/fs-actions.js`),await crs.modules.add("html",`${a}/action-systems/html-actions.js`),await crs.modules.add("local_storage",`${a}/action-systems/local-storage-actions.js`),await crs.modules.add("loop",`${a}/action-systems/loop-actions.js`),await crs.modules.add("markdown",`${a}/action-systems/markdown-actions.js`),await crs.modules.add("math",`${a}/action-systems/math-actions.js`),await crs.modules.add("media",`${a}/action-systems/media-actions.js`),await crs.modules.add("module",`${a}/action-systems/module-actions.js`),await crs.modules.add("no_content",`${a}/action-systems/no-content-actions.js`),await crs.modules.add("object",`${a}/action-systems/object-actions.js`),await crs.modules.add("process",`${a}/action-systems/process-actions.js`),await crs.modules.add("random",`${a}/action-systems/random-actions.js`),await crs.modules.add("rest_services",`${a}/action-systems/rest-services-actions.js`),await crs.modules.add("route",`${a}/action-systems/route-actions.js`),await crs.modules.add("schema",`${a}/action-systems/schema-actions.js`),await crs.modules.add("scripts",`${a}/action-systems/scripts-actions.js`),await crs.modules.add("session_storage",`${a}/action-systems/session-storage-actions.js`),await crs.modules.add("string",`${a}/action-systems/string-actions.js`),await crs.modules.add("styles",`${a}/action-systems/styles-actions.js`),await crs.modules.add("system",`${a}/action-systems/system-actions.js`),await crs.modules.add("switch",`${a}/action-systems/switch-actions.js`),await crs.modules.add("translations",`${a}/action-systems/translations-actions.js`),await crs.modules.add("validate",`${a}/action-systems/validate-actions.js`),crs.dom=(await crs.modules.get("dom")).DomActions,globalThis.isMobile=await crs.call("system","is_mobile")}globalThis.crs=globalThis.crs||{};globalThis.crs.intent={};globalThis.crs.processSchemaRegistry=new u;globalThis.crs.process=m;globalThis.crs.AsyncFunction=Object.getPrototypeOf(async function(){}).constructor;globalThis.crs.call=async(a,t,s,e,i,n,d=null)=>{crs.intent[a]==null&&await crs.modules.get(a),i==null&&(i={expCache:{},functions:{}},f(d,i));let c=crs.intent[a];return c[t]==null?await c.perform({action:t,args:s},e,i,n):await c[t]({args:s},e,i,n)};globalThis.crs.getNextStep=(a,t)=>typeof t=="object"?t:crs.binding.utils.getValueOnPath(a.steps,t);crs.binding.events.emitter.on("crs-process-error",a=>{console.error(a.error)});export{v as initialize};
